!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

module calc_cell_orientation_kernel_mod_test

  use pFUnit_Mod
  use constants_mod,      only : i_def, r_def

  implicit none

contains

  @test
  subroutine test_of_cell_orientation()

    use calc_cell_orientation_kernel_mod, only : calc_cell_orientation_code

    implicit none

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    integer          :: nlayers
    integer          :: ndf_w0, ndf_w2, ndf_w3
    integer          :: undf_w0, undf_w3

    integer, allocatable :: stencil_map_w2_cross(:,:)
    integer, allocatable :: stencil_map_w3_cross(:,:)
    integer, allocatable :: map_w3(:)
    integer :: size_of_stencil
    real(kind=r_def),allocatable :: orientation(:)

    nlayers = 1
    ndf_w2 = 4
    ndf_w3 = 1
    undf_w3 = 9
    ndf_w2 = 4
    size_of_stencil = 9

    allocate(stencil_map_w2_cross(1:ndf_w2,1:size_of_stencil))
    allocate(stencil_map_w3_cross(1:ndf_w3,1:size_of_stencil))

    allocate(map_w3(1:ndf_w3))

    allocate(orientation(1:undf_w3))

    stencil_map_w3_cross(1,1:size_of_stencil) = (/ 1,2,3,4,5,6,7,8,9 /)

    stencil_map_w2_cross(1:4,1) = (/ 101, 102, 103, 104 /)
    stencil_map_w2_cross(1:4,2) = (/ 105, 101, 107, 106 /)
    stencil_map_w2_cross(1:4,3) = (/ 129, 106, 127, 128 /)
    stencil_map_w2_cross(1:4,4) = (/ 102, 111, 113, 114 /)
    stencil_map_w2_cross(1:4,5) = (/ 132, 113, 130, 131 /)
    stencil_map_w2_cross(1:4,6) = (/ 119, 120, 103, 118 /)
    stencil_map_w2_cross(1:4,7) = (/ 119, 133, 134, 135 /)
    stencil_map_w2_cross(1:4,8) = (/ 104, 126, 125, 124 /)
    stencil_map_w2_cross(1:4,9) = (/ 125, 136, 137, 140 /)

    map_w3(:) = 1

    call calc_cell_orientation_code( nlayers,                       &
                                     orientation,                   &
                                     undf_w3,                       &
                                     ndf_w3,                        &
                                     map_w3  ,                      &
                                     ndf_w2,                        &
                                     size_of_stencil,               &
                                     stencil_map_w2_cross,          &
                                     stencil_map_w3_cross )

    @assertEqual(1_r_def, orientation(1), tol)
    @assertEqual(4_r_def, orientation(2), tol)
    @assertEqual(4_r_def, orientation(3), tol)
    @assertEqual(2_r_def, orientation(4), tol)
    @assertEqual(3_r_def, orientation(5), tol)
    @assertEqual(3_r_def, orientation(6), tol)
    @assertEqual(1_r_def, orientation(7), tol)
    @assertEqual(4_r_def, orientation(8), tol)
    @assertEqual(4_r_def, orientation(9), tol)

  end subroutine test_of_cell_orientation

end module calc_cell_orientation_kernel_mod_test
